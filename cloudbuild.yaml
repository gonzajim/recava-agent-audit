substitutions: {} # anula cualquier substitutions heredada

availableSecrets:
  secretManager:
    - versionName: projects/recava-agent-audit/secrets/OPENAI_API_KEY/versions/latest
      env: _OPENAI_API_KEY # Mapeado a la variable de entorno _OPENAI_API_KEY en el build step
    - versionName: projects/recava-agent-audit/secrets/ORCHESTRATOR_ASSISTANT_ID/versions/latest
      env: _ORCHESTRATOR_ASSISTANT_ID # Mapeado a _ORCHESTRATOR_ASSISTANT_ID
    - versionName: projects/recava-agent-audit/secrets/ASISTENTE_ID/versions/latest
      env: _ASISTENTE_ID # Mapeado a _ASISTENTE_ID
    - versionName: projects/recava-agent-audit/secrets/AUDITOR_ID/versions/latest
      env: _AUDITOR_ID # Mapeado a _AUDITOR_ID

steps:
  # 1) Build la imagen del contenedor
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'europe-west1-docker.pkg.dev/recava-agent-audit/orchestrator-repo/orchestrator:latest', '.']

  # 2) Push la imagen a Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'europe-west1-docker.pkg.dev/recava-agent-audit/orchestrator-repo/orchestrator:latest']

  # 3) Deploy a Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    secretEnv: # Variables de entorno (con valores de secretos) disponibles para este paso de build
      - _OPENAI_API_KEY
      - _ORCHESTRATOR_ASSISTANT_ID
      - _ASISTENTE_ID
      - _AUDITOR_ID
    args:
      - -c
      - |
        gcloud run deploy orchestrator \
          --image=europe-west1-docker.pkg.dev/recava-agent-audit/orchestrator-repo/orchestrator:latest \
          --region=europe-west1 \
          --platform=managed \
          --allow-unauthenticated \
          --port=8080 \
          --set-env-vars="OPENAI_API_KEY=$_OPENAI_API_KEY,ORCHESTRATOR_ASSISTANT_ID=$_ORCHESTRATOR_ASSISTANT_ID,ASISTENTE_ID=$_ASISTENTE_ID,AUDITOR_ID=$_AUDITOR_ID" \
          --timeout=300s \
          --concurrency=80 \
          --cpu=1 \
          --memory=512Mi
          # Considera a√±adir --min-instances y --max-instances si es necesario

images:
  - 'europe-west1-docker.pkg.dev/recava-agent-audit/orchestrator-repo/orchestrator:latest'

options:
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET
