substitutions: {}          # anula cualquier substitutions heredada

availableSecrets:
  secretManager:
    - versionName: projects/recava-agent-audit/secrets/OPENAI_API_KEY/versions/latest
      env: _OPENAI_API_KEY          # ← guion bajo
    - versionName: projects/recava-agent-audit/secrets/ASISTENTE_ID/versions/latest
      env: _ASISTENTE_ID
    - versionName: projects/recava-agent-audit/secrets/AUDITOR_ID/versions/latest
      env: _AUDITOR_ID

steps:
  # 1) Build
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build','-t','europe-west1-docker.pkg.dev/recava-agent-audit/orchestrator-repo/orchestrator','.']

  # 2) Push
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push','europe-west1-docker.pkg.dev/recava-agent-audit/orchestrator-repo/orchestrator']

  # 3) Deploy
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    secretEnv:       # ← usa los nombres con _
      - _OPENAI_API_KEY
      - _ASISTENTE_ID
      - _AUDITOR_ID
    args:
      - -c
      - |
        gcloud run deploy orchestrator \
          --image=europe-west1-docker.pkg.dev/recava-agent-audit/orchestrator-repo/orchestrator \
          --region=europe-west1 \
          --platform=managed \
          --allow-unauthenticated \
          --set-env-vars \
              OPENAI_API_KEY=$_OPENAI_API_KEY,\
              ASISTENTE_ID=$_ASISTENTE_ID,\
              AUDITOR_ID=$_AUDITOR_ID

images:
  - 'europe-west1-docker.pkg.dev/recava-agent-audit/orchestrator-repo/orchestrator'

options:
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET
